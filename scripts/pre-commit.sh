#!/bin/bash
# Pre-commit hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
# –ü—Ä–æ–µ–∫—Ç: –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–∞—Ä—å–µ—Ä–∞

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º...${NC}"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–µ—Ä–µ—Ö–æ–¥–∏–º –∏–∑ .git/hooks –≤ –∫–æ—Ä–µ–Ω—å)
PROJECT_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$SCRIPTS_DIR/check_docs_sync.py" ]; then
    echo -e "${RED}‚ùå –°–∫—Ä–∏–ø—Ç check_docs_sync.py –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $SCRIPTS_DIR${NC}"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
cd "$PROJECT_ROOT"
python "$SCRIPTS_DIR/check_docs_sync.py" --strict

# –ü–æ–ª—É—á–∞–µ–º exit code
EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –ö–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω.${NC}"
    exit 0
elif [ $EXIT_CODE -eq 1 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.${NC}"
    echo -e "${BLUE}üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:${NC}"
    echo -e "${BLUE}   python scripts/update_docs.py${NC}"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–º–º–∏—Ç –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}‚è≠Ô∏è  –ö–æ–º–º–∏—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏.${NC}"
        exit 0
    else
        echo -e "${YELLOW}‚è∏Ô∏è  –ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω—ë–Ω. –û–±–Ω–æ–≤–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
        exit 1
    fi
elif [ $EXIT_CODE -eq 2 ]; then
    echo -e "${YELLOW}‚öôÔ∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...${NC}"
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    python "$SCRIPTS_DIR/update_docs.py" --auto
    UPDATE_EXIT_CODE=$?
    
    if [ $UPDATE_EXIT_CODE -eq 0 ]; then
        echo -e "${GREEN}‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞${NC}"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç
        git add CHANGELOG.md docs/factory/reports/ASSESSMENT.md README.md 2>/dev/null
        
        echo -e "${GREEN}‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ–º–º–∏—Ç. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º...${NC}"
        exit 0
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏${NC}"
        echo -e "${BLUE}üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é:${NC}"
        echo -e "${BLUE}   python scripts/update_docs.py${NC}"
        exit 1
    fi
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (exit code: $EXIT_CODE)${NC}"
    echo -e "${BLUE}üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä—É—á–Ω—É—é:${NC}"
    echo -e "${BLUE}   python scripts/check_docs_sync.py${NC}"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–º–º–∏—Ç –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –ö–æ–º–º–∏—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω —Å –æ—à–∏–±–∫–æ–π –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.${NC}"
        exit 0
    else
        echo -e "${YELLOW}‚è∏Ô∏è  –ö–æ–º–º–∏—Ç –æ—Ç–º–µ–Ω—ë–Ω. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
        exit 1
    fi
fi
