name: Documentation Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  check-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –ù—É–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–º–∏—Ç–∞
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # –ù—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è git
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Check documentation sync
      id: check
      continue-on-error: true
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
        python scripts/check_docs_sync.py --strict
        echo "exit_code=$?" >> $GITHUB_OUTPUT
        
    - name: Auto-update documentation if needed
      if: steps.check.outputs.exit_code == '2'
      run: |
        echo "‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
        python scripts/update_docs.py --auto
        
    - name: Commit and push if changed
      if: steps.check.outputs.exit_code == '2'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if [[ -n $(git status --porcelain) ]]; then
          echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
          git add CHANGELOG.md ASSESSMENT.md README.md
          git commit -m "docs: Auto-update documentation [skip ci]
          
          - Updated by GitHub Actions workflow
          - Triggered by commit ${{ github.sha }}
          - Auto-generated at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          git push
          echo "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞"
        else
          echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        fi
        
    - name: Final check
      if: steps.check.outputs.exit_code == '2'
      run: |
        echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
        python scripts/check_docs_sync.py --strict
        
    - name: Comment on PR if auto-fixed
      if: steps.check.outputs.exit_code == '2' && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!**\n\n' +
                  'GitHub Actions –æ–±–Ω–∞—Ä—É–∂–∏–ª —É—Å—Ç–∞—Ä–µ–≤—à—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏–ª –µ—ë.\n\n' +
                  '–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:\n' +
                  '- `CHANGELOG.md`\n' +
                  '- `ASSESSMENT.md`\n\n' +
                  '–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ [–ª–æ–≥–∞—Ö CI](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ').'
          })